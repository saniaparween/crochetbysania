<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout | Crochet by Sania</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/product-pages.css" />
    <style>
        .checkout-container{
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .checkout-section{
            margin-top: 20px;
            padding: 20px;
            border-radius: 18px;
            border: 1px solid var(--border);
            background: var(--panel);
        }
        .checkout-section h2{
            margin: 0 0 16px;
            font-size: 18px;
        }
        .form-group{
            margin-bottom: 16px;
        }
        .form-group label{
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--muted);
        }
        .form-group input,
        .form-group textarea{
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group textarea:focus{
            outline: none;
            border-color: rgba(255,255,255,0.3);
        }
        .order-item{
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .order-item:last-child{
            border-bottom: none;
        }
        .order-item img{
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .order-item-info{
            flex: 1;
        }
        .order-item-name{
            font-weight: 600;
            margin-bottom: 4px;
        }
        .order-item-meta{
            font-size: 13px;
            color: var(--muted);
        }
        .order-total{
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            font-size: 18px;
            font-weight: 700;
            border-top: 2px solid var(--border);
            margin-top: 16px;
        }
        .pay-btn{
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            background: rgba(255,255,255,0.92);
            color: #0b0b0f;
            font-weight: 750;
            font-size: 16px;
            border: 0;
            cursor: pointer;
            transition: all .2s ease;
            margin-top: 20px;
        }
        .pay-btn:hover{
            background: rgba(255,255,255,0.98);
            transform: translateY(-1px);
        }
        .pay-btn:disabled{
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Category navigation">
        <div class="sidebar-card">
            <div class="sidebar-title">Categories</div>
            <nav class="nav">
                <a href="../index.html">
                    <span>Home</span>
                    <span class="hint">üè†</span>
                </a>
                <a href="accessories.html">
                    <span>Accessories</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="handbags.html">
                    <span>Handbags</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="flowers.html">
                    <span>Flowers</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="home-decor.html">
                    <span>Home decor</span>
                    <span class="hint">‚Üí</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <!-- Top bar -->
        <header class="topbar">
            <div class="topbar-inner">
                <div class="brand">
                    <button class="icon-btn" id="menuBtn" aria-label="Open menu">
                        ‚ò∞
                    </button>
                </div>

                <a href="../index.html" class="brand-text">
                    <h1>Crochet by Sania</h1>
                </a>

                <div class="top-actions" data-header-right>
                    <!-- cart button will be injected here -->
                </div>
            </div>
        </header>

        <div class="checkout-container">
            <div style="margin-top: 16px;">
                <span class="tag">Checkout</span>
            </div>
            <button class="icon-btn" onclick="history.back()" aria-label="Go back" style="margin-top: 12px;">
                ‚Üê Back
            </button>

            <!-- Order Summary -->
            <div class="checkout-section">
                <h2>Order Summary</h2>
                <div id="orderItems"></div>
                <div class="order-total">
                    <span>Total</span>
                    <span id="orderTotal">‚Çπ0</span>
                </div>
            </div>

            <!-- Customer Details -->
            <div class="checkout-section">
                <h2>Your Details</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="customerName">Full Name *</label>
                        <input type="text" id="customerName" required placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number *</label>
                        <input type="tel" id="customerPhone" required placeholder="10-digit mobile number" pattern="[0-9]{10}">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email (Optional)</label>
                        <input type="email" id="customerEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Delivery Address *</label>
                        <textarea id="customerAddress" required rows="3" placeholder="Enter your complete delivery address"></textarea>
                    </div>
                </form>
            </div>

            <!-- Payment -->
            <div class="checkout-section">
                <h2>Payment via UPI</h2>

                <div id="paymentInfo" style="display: none; background: rgba(255,255,255,0.08); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--muted); font-size: 14px;">Amount to Pay:</span>
                        <span style="font-size: 20px; font-weight: 700;" id="displayAmount">‚Çπ0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--muted); font-size: 14px;">Order ID:</span>
                        <span style="font-size: 14px; font-weight: 600;" id="displayOrderId">-</span>
                    </div>
                </div>

                <button class="pay-btn" id="payBtn">Pay with UPI</button>

                <div id="upiOptions" style="display: none; margin-top: 20px;">
                    <p style="color: var(--muted); font-size: 14px; margin-bottom: 12px; text-align: center;">
                        Your UPI app will open automatically.<br>
                        Complete the payment and take a screenshot.
                    </p>
                    <div style="display: grid; gap: 12px;">
                        <button class="icon-btn" style="width: 100%; padding: 14px; font-size: 15px;" data-upi="generic">
                            üì± Open UPI App
                        </button>
                        <button class="icon-btn" style="width: 100%; padding: 14px; font-size: 15px;" data-upi="gpay">
                            üí∞ Google Pay
                        </button>
                        <button class="icon-btn" style="width: 100%; padding: 14px; font-size: 15px;" data-upi="phonepe">
                            üì≤ PhonePe
                        </button>
                        <button class="icon-btn" style="width: 100%; padding: 14px; font-size: 15px;" data-upi="paytm">
                            üí≥ Paytm
                        </button>
                    </div>
                    <p style="color: var(--muted); font-size: 12px; margin-top: 16px; text-align: center; line-height: 1.5;">
                        If payment doesn't work, manually pay to:<br>
                        <strong style="color: var(--text);">sania96.parween-1@okicici</strong>
                    </p>
                </div>

                <p style="color: var(--muted); font-size: 13px; margin-top: 16px; text-align: center;">
                    After payment, WhatsApp screenshot to <strong style="color: var(--text);">+91-XXXXXXXXXX</strong>
                </p>
            </div>
        </div>
    </main>
</div>

<script src="../js/products-data.js"></script>
<script src="../js/cart.js"></script>
<script>
    // Mobile sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    const menuBtn = document.getElementById('menuBtn');

    function openSidebar(){
      sidebar.classList.add('open');
      backdrop.classList.add('show');
      menuBtn.setAttribute('aria-expanded', 'true');
    }
    function closeSidebar(){
      sidebar.classList.remove('open');
      backdrop.classList.remove('show');
      menuBtn.setAttribute('aria-expanded', 'false');
    }

    menuBtn.addEventListener('click', () => {
      const isOpen = sidebar.classList.contains('open');
      isOpen ? closeSidebar() : openSidebar();
    });

    backdrop.addEventListener('click', closeSidebar);

    // Close sidebar when clicking a nav link (mobile)
    document.querySelectorAll('.nav a').forEach(a => {
      a.addEventListener('click', () => {
        if (window.matchMedia('(max-width: 980px)').matches) closeSidebar();
      });
    });

    // Checkout logic
    const CART_KEY = "cbs_cart_v1";

    function readCart() {
        try { return JSON.parse(localStorage.getItem(CART_KEY)) ?? []; }
        catch { return []; }
    }

    function currencyINR(amount) {
        return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", maximumFractionDigits: 0 }).format(amount);
    }

    function getProduct(productId) {
        return (window.PRODUCTS || []).find(p => p.id === productId);
    }

    // Load order summary
    const cart = readCart();
    if (cart.length === 0) {
        alert('Your cart is empty!');
        window.location.href = '../index.html';
    }

    let total = 0;
    const orderItemsHtml = cart.map(item => {
        const p = getProduct(item.productId);
        if (!p) return '';
        const line = p.price * item.qty;
        total += line;

        return `
            <div class="order-item">
                <img src="${p.img}" alt="${p.name}">
                <div class="order-item-info">
                    <div class="order-item-name">${p.name}</div>
                    <div class="order-item-meta">Qty: ${item.qty} √ó ${currencyINR(p.price)}</div>
                </div>
                <div style="font-weight: 600;">${currencyINR(line)}</div>
            </div>
        `;
    }).join('');

    document.getElementById('orderItems').innerHTML = orderItemsHtml;
    document.getElementById('orderTotal').textContent = currencyINR(total);

    let orderData = null;

    // Show UPI options
    document.getElementById('payBtn').addEventListener('click', () => {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const name = document.getElementById('customerName').value;
        const phone = document.getElementById('customerPhone').value;
        const email = document.getElementById('customerEmail').value;
        const address = document.getElementById('customerAddress').value;

        // Generate order
        orderData = {
            orderId: 'ORD-' + Date.now(),
            timestamp: new Date().toISOString(),
            customer: { name, phone, email, address },
            items: cart,
            total: total,
            paymentMethod: 'UPI',
            status: 'pending',
            upiId: 'sania96.parween-1@okicici'
        };

        // Store order
        const orders = JSON.parse(localStorage.getItem('cbs_orders') || '[]');
        orders.push(orderData);
        localStorage.setItem('cbs_orders', JSON.stringify(orders));

        // Show payment options
        document.getElementById('payBtn').style.display = 'none';
        document.getElementById('paymentInfo').style.display = 'block';
        document.getElementById('upiOptions').style.display = 'block';
        document.getElementById('displayAmount').textContent = currencyINR(total);
        document.getElementById('displayOrderId').textContent = orderData.orderId;
    });

    // Build UPI URL with proper encoding
    function buildUpiUrl({ pa, pn, am, tn, tr }) {
        const params = new URLSearchParams();
        params.set("pa", pa);                // payee VPA
        params.set("pn", pn);                // payee name
        params.set("am", String(am));        // amount
        params.set("cu", "INR");             // currency
        if (tn) params.set("tn", tn);        // note
        if (tr) params.set("tr", tr);        // transaction ref (important)
        return `upi://pay?${params.toString()}`;
    }

    // Handle UPI payment - standard approach
    document.querySelectorAll('[data-upi]').forEach(btn => {
        btn.addEventListener('click', () => {
            const upiId = 'sania96.parween-1@okicici';
            const merchantName = 'Crochet by Sania';
            const amount = total.toFixed(2);
            const transactionNote = `Order payment`;
            const tr = orderData?.orderId || `ORD-${Date.now()}`;

            // Build standard UPI URL - works for all apps
            const upiUrl = buildUpiUrl({
                pa: upiId,
                pn: merchantName,
                am: amount,
                tn: transactionNote,
                tr: tr
            });

            // Open UPI app
            window.location.href = upiUrl;

            // Show confirmation after delay
            setTimeout(() => {
                const confirmed = confirm('Have you completed the payment?\n\n‚úì Click OK if payment is done\n‚úó Click Cancel if you need to try again');

                if (confirmed) {
                    localStorage.removeItem(CART_KEY);
                    alert('Thank you for your order!\n\nOrder ID: ' + orderData.orderId + '\n\nPlease WhatsApp your payment screenshot for confirmation.');
                    window.location.href = '../index.html';
                }
            }, 2000);
        });
    });
</script>
</body>
</html>
