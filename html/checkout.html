<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Checkout | Crochet by Sania</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/product-pages.css" />
    <style>
        .checkout-container{
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .checkout-section{
            margin-top: 20px;
            padding: 20px;
            border-radius: 18px;
            border: 1px solid var(--border);
            background: var(--panel);
        }
        .checkout-section h2{
            margin: 0 0 16px;
            font-size: 18px;
        }
        .form-group{
            margin-bottom: 16px;
        }
        .form-group label{
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--muted);
        }
        .form-group input,
        .form-group textarea{
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: var(--text);
            font-family: inherit;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group textarea:focus{
            outline: none;
            border-color: rgba(255,255,255,0.3);
        }
        .order-item{
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .order-item:last-child{
            border-bottom: none;
        }
        .order-item img{
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .order-item-info{
            flex: 1;
        }
        .order-item-name{
            font-weight: 600;
            margin-bottom: 4px;
        }
        .order-item-meta{
            font-size: 13px;
            color: var(--muted);
        }
        .order-total{
            display: flex;
            justify-content: space-between;
            padding: 16px 0;
            font-size: 18px;
            font-weight: 700;
            border-top: 2px solid var(--border);
            margin-top: 16px;
        }
        .pay-btn{
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            background: rgba(255,255,255,0.92);
            color: #0b0b0f;
            font-weight: 750;
            font-size: 16px;
            border: 0;
            cursor: pointer;
            transition: all .2s ease;
            margin-top: 20px;
        }
        .pay-btn:hover{
            background: rgba(255,255,255,0.98);
            transform: translateY(-1px);
        }
        .pay-btn:disabled{
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
<div class="backdrop" id="backdrop" aria-hidden="true"></div>

<div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" aria-label="Category navigation">
        <div class="sidebar-card">
            <div class="sidebar-title">Categories</div>
            <nav class="nav">
                <a href="../index.html">
                    <span>Home</span>
                    <span class="hint">üè†</span>
                </a>
                <a href="accessories.html">
                    <span>Accessories</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="handbags.html">
                    <span>Handbags</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="flowers.html">
                    <span>Flowers</span>
                    <span class="hint">‚Üí</span>
                </a>
                <a href="home-decor.html">
                    <span>Home decor</span>
                    <span class="hint">‚Üí</span>
                </a>
            </nav>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <!-- Top bar -->
        <header class="topbar">
            <div class="topbar-inner">
                <div class="brand">
                    <button class="icon-btn" id="menuBtn" aria-label="Open menu">
                        ‚ò∞
                    </button>
                </div>

                <a href="../index.html" class="brand-text">
                    <h1>Crochet by Sania</h1>
                </a>

                <div class="top-actions" data-header-right>
                    <!-- cart button will be injected here -->
                </div>
            </div>
        </header>

        <div class="checkout-container">
            <div style="margin-top: 16px;">
                <span class="tag">Checkout</span>
            </div>
            <button class="icon-btn" onclick="history.back()" aria-label="Go back" style="margin-top: 12px;">
                ‚Üê Back
            </button>

            <!-- Order Summary -->
            <div class="checkout-section">
                <h2>Order Summary</h2>
                <div id="orderItems"></div>
                <div class="order-total">
                    <span>Total</span>
                    <span id="orderTotal">‚Çπ0</span>
                </div>
            </div>

            <!-- Customer Details -->
            <div class="checkout-section">
                <h2>Your Details</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="customerName">Full Name *</label>
                        <input type="text" id="customerName" required placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number *</label>
                        <input type="tel" id="customerPhone" required placeholder="10-digit mobile number" pattern="[0-9]{10}">
                    </div>
                    <div class="form-group">
                        <label for="customerEmail">Email (Optional)</label>
                        <input type="email" id="customerEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="customerAddress">Delivery Address *</label>
                        <textarea id="customerAddress" required rows="3" placeholder="Enter your complete delivery address"></textarea>
                    </div>
                </form>
            </div>

            <!-- Payment -->
            <div class="checkout-section">
                <h2>Payment via UPI</h2>
                <p style="color: var(--muted); font-size: 14px; margin: 0 0 16px;">
                    Pay using UPI ID: <strong style="color: var(--text);">sania96.parween-1@okicici</strong>
                </p>

                <div id="qrCodeContainer" style="text-align: center; margin: 20px 0; display: none;">
                    <div style="background: white; padding: 20px; border-radius: 12px; display: inline-block;">
                        <canvas id="qrCanvas"></canvas>
                    </div>
                    <p style="margin-top: 12px; font-size: 14px; color: var(--muted);">Scan this QR code with any UPI app to pay</p>
                </div>

                <button class="pay-btn" id="payBtn">Generate UPI Payment Link</button>
                <div id="upiOptions" style="display: none; margin-top: 16px;">
                    <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Choose your UPI app:</p>
                    <div style="display: grid; gap: 10px;">
                        <button class="icon-btn" style="width: 100%; padding: 12px;" data-upi="gpay">Google Pay</button>
                        <button class="icon-btn" style="width: 100%; padding: 12px;" data-upi="phonepe">PhonePe</button>
                        <button class="icon-btn" style="width: 100%; padding: 12px;" data-upi="paytm">Paytm</button>
                        <button class="icon-btn" style="width: 100%; padding: 12px;" data-upi="generic">Other UPI App</button>
                    </div>
                </div>

                <p style="color: var(--muted); font-size: 13px; margin-top: 16px; text-align: center;">
                    After payment, please WhatsApp screenshot to <strong style="color: var(--text);">+91-XXXXXXXXXX</strong>
                </p>
            </div>
        </div>
    </main>
</div>

<script src="../js/products-data.js"></script>
<script src="../js/cart.js"></script>
<script>
    // Mobile sidebar toggle
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('backdrop');
    const menuBtn = document.getElementById('menuBtn');

    function openSidebar(){
      sidebar.classList.add('open');
      backdrop.classList.add('show');
      menuBtn.setAttribute('aria-expanded', 'true');
    }
    function closeSidebar(){
      sidebar.classList.remove('open');
      backdrop.classList.remove('show');
      menuBtn.setAttribute('aria-expanded', 'false');
    }

    menuBtn.addEventListener('click', () => {
      const isOpen = sidebar.classList.contains('open');
      isOpen ? closeSidebar() : openSidebar();
    });

    backdrop.addEventListener('click', closeSidebar);

    // Close sidebar when clicking a nav link (mobile)
    document.querySelectorAll('.nav a').forEach(a => {
      a.addEventListener('click', () => {
        if (window.matchMedia('(max-width: 980px)').matches) closeSidebar();
      });
    });

    // Checkout logic
    const CART_KEY = "cbs_cart_v1";

    function readCart() {
        try { return JSON.parse(localStorage.getItem(CART_KEY)) ?? []; }
        catch { return []; }
    }

    function currencyINR(amount) {
        return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", maximumFractionDigits: 0 }).format(amount);
    }

    function getProduct(productId) {
        return (window.PRODUCTS || []).find(p => p.id === productId);
    }

    // Load order summary
    const cart = readCart();
    if (cart.length === 0) {
        alert('Your cart is empty!');
        window.location.href = '../index.html';
    }

    let total = 0;
    const orderItemsHtml = cart.map(item => {
        const p = getProduct(item.productId);
        if (!p) return '';
        const line = p.price * item.qty;
        total += line;

        return `
            <div class="order-item">
                <img src="${p.img}" alt="${p.name}">
                <div class="order-item-info">
                    <div class="order-item-name">${p.name}</div>
                    <div class="order-item-meta">Qty: ${item.qty} √ó ${currencyINR(p.price)}</div>
                </div>
                <div style="font-weight: 600;">${currencyINR(line)}</div>
            </div>
        `;
    }).join('');

    document.getElementById('orderItems').innerHTML = orderItemsHtml;
    document.getElementById('orderTotal').textContent = currencyINR(total);

    // Simple QR Code generation
    function generateQRCode(text, canvas) {
        const size = 200;
        const qrSize = 29; // 29x29 grid for QR code version 3
        const moduleSize = Math.floor(size / qrSize);

        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        // Fill white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, size, size);

        // For demo: just show the UPI string as text since generating actual QR is complex
        ctx.fillStyle = 'black';
        ctx.font = '10px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('UPI Payment', size/2, size/2 - 20);
        ctx.fillText(text.substring(0, 30), size/2, size/2);
        ctx.fillText(text.substring(30, 60), size/2, size/2 + 15);
        ctx.fillText('(Use QR code generator)', size/2, size/2 + 40);
    }

    let orderData = null;

    // UPI Payment - Show options
    document.getElementById('payBtn').addEventListener('click', () => {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const name = document.getElementById('customerName').value;
        const phone = document.getElementById('customerPhone').value;
        const email = document.getElementById('customerEmail').value;
        const address = document.getElementById('customerAddress').value;

        const upiId = 'sania96.parween-1@okicici';
        const merchantName = 'Crochet by Sania';
        const amount = total;
        const transactionNote = `Order-${phone.slice(-4)}`;

        // Save order details
        orderData = {
            orderId: 'ORD-' + Date.now(),
            timestamp: new Date().toISOString(),
            customer: { name, phone, email, address },
            items: cart,
            total: amount,
            paymentMethod: 'UPI',
            status: 'pending',
            upiId: upiId
        };

        // Show UPI options
        document.getElementById('payBtn').style.display = 'none';
        document.getElementById('upiOptions').style.display = 'block';

        // Generate QR Code (placeholder - use actual QR library for production)
        const upiString = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
        const canvas = document.getElementById('qrCanvas');
        generateQRCode(upiString, canvas);
        document.getElementById('qrCodeContainer').style.display = 'block';
    });

    // Handle UPI app selection
    document.querySelectorAll('[data-upi]').forEach(btn => {
        btn.addEventListener('click', () => {
            const app = btn.getAttribute('data-upi');
            const upiId = 'sania96.parween-1@okicici';
            const merchantName = 'Crochet by Sania';
            const amount = total.toFixed(2); // Format amount with 2 decimals
            const phone = document.getElementById('customerPhone').value;
            const transactionNote = `Order-${phone.slice(-4)}`;

            // Standard UPI URL format (works for most apps)
            let upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;

            // App-specific URLs (some apps use different schemes)
            if (app === 'gpay') {
                // Google Pay uses tez:// or gpay://
                upiUrl = `tez://upi/pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            } else if (app === 'phonepe') {
                // PhonePe uses phonepe://
                upiUrl = `phonepe://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            } else if (app === 'paytm') {
                // Paytm uses paytmmp://
                upiUrl = `paytmmp://pay?pa=${upiId}&pn=${encodeURIComponent(merchantName)}&am=${amount}&cu=INR&tn=${encodeURIComponent(transactionNote)}`;
            }

            // Store order
            const orders = JSON.parse(localStorage.getItem('cbs_orders') || '[]');
            orders.push(orderData);
            localStorage.setItem('cbs_orders', JSON.stringify(orders));

            // Try to open UPI app - use window.location for better compatibility
            window.location.href = upiUrl;

            // Show confirmation after delay
            setTimeout(() => {
                if (confirm('Have you completed the payment?\n\nClick OK if payment is done.\n\nPlease WhatsApp payment screenshot for confirmation.')) {
                    localStorage.removeItem(CART_KEY);
                    alert('Thank you! Order ID: ' + orderData.orderId + '\n\nWe will contact you shortly to confirm delivery.');
                    window.location.href = '../index.html';
                } else {
                    alert('Please complete the payment and WhatsApp the screenshot.\n\nOrder ID: ' + orderData.orderId);
                }
            }, 1500);
        });
    });
</script>
</body>
</html>
